<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>马年迎好运活动管理后台</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- SheetJS for Excel handling -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- 自定义 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3182ce',
                        secondary: '#718096',
                        accent: '#4299e1',
                        dark: '#2d3748',
                        light: '#f7fafc'
                    },
                    fontFamily: {
                        sans: ['Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            }
            .bg-blur {
                backdrop-filter: blur(8px);
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 背景图片 -->
    <div class="fixed inset-0 w-full h-full bg-cover bg-center z-0 opacity-10" style="background-image: url('https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/3a85add7ebf84d7eb85a7b2cb882c2d7~tplv-a9rns2rl98-image.image?lk3s=8e244e95&rcl=20260202154232E27B1865A8D2BA36CEDD&rrcfp=f06b921b&x-expires=1772610203&x-signature=h8SRuN40TjxW07ln1RkiQN8tzfg%3D');">
    </div>

    <!-- 顶部导航栏 -->
    <header class="bg-primary text-white shadow-md relative z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fa fa-trophy text-2xl mr-3"></i>
                <h1 class="text-xl font-bold">马年迎好运活动管理后台</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="back-to-draw" class="px-4 py-2 bg-white text-primary rounded hover:bg-gray-100 transition-all-300 flex items-center">
                    <i class="fa fa-arrow-left mr-2"></i> 返回迎好运页
                </button>
                <button id="logout-button" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-all-300 flex items-center">
                    <i class="fa fa-sign-out mr-2"></i> 退出
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-8 relative z-10">
        <!-- 数据管理卡片 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-database mr-2 text-primary"></i> 数据管理
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 导入抽奖名单 -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">导入迎好运名单</h3>
                    <p class="text-sm text-gray-500 mb-4">上传包含参与者姓名的Excel文件（.xlsx格式）</p>
                    
                    <div class="flex flex-col space-y-3">
                        <input type="file" id="participants-file" accept=".xlsx,.xls" class="hidden">
                        <label for="participants-file" class="px-4 py-2 bg-primary text-white rounded cursor-pointer hover:bg-blue-600 transition-all-300 text-center">
                            <i class="fa fa-upload mr-2"></i> 选择Excel文件
                        </label>
                        <div id="participants-file-name" class="text-sm text-gray-600 truncate"></div>
                        <button id="import-participants" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-all-300 disabled:bg-gray-300 disabled:cursor-not-allowed">
                            <i class="fa fa-check mr-2"></i> 导入名单
                        </button>
                    </div>
                </div>
                
                <!-- 导入奖项设置 -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">导入好运设置</h3>
                    <p class="text-sm text-gray-500 mb-4">上传包含奖项名称和数量的Excel文件（.xlsx格式）</p>
                    
                    <div class="flex flex-col space-y-3">
                        <input type="file" id="prizes-file" accept=".xlsx,.xls" class="hidden">
                        <label for="prizes-file" class="px-4 py-2 bg-primary text-white rounded cursor-pointer hover:bg-blue-600 transition-all-300 text-center">
                            <i class="fa fa-upload mr-2"></i> 选择Excel文件
                        </label>
                        <div id="prizes-file-name" class="text-sm text-gray-600 truncate"></div>
                        <button id="import-prizes" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-all-300 disabled:bg-gray-300 disabled:cursor-not-allowed">
                            <i class="fa fa-check mr-2"></i> 导入好运
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 导出中奖名单 -->
            <div class="mt-6 border border-gray-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">导出抽好运名单</h3>
                <p class="text-sm text-gray-500 mb-4">将中奖记录导出为Excel文件</p>
                
                <button id="export-winners" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-all-300 flex items-center">
                    <i class="fa fa-download mr-2"></i> 导出Excel文件
                </button>
            </div>
        </div>
        
        <!-- 奖项管理卡片 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-gift mr-2 text-primary"></i> 好运管理
            </h2>
            
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                好运名称
                            </th>
                            <th class="py-3 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                总数量
                            </th>
                            <th class="py-3 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                剩余数量
                            </th>
                            <th class="py-3 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                已抽取
                            </th>
                            <th class="py-3 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                操作
                            </th>
                        </tr>
                    </thead>
                    <tbody id="prizes-table-body">
                        <!-- 奖项数据将通过JS动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 添加奖项按钮 -->
            <div class="mt-6 flex justify-end">
                <button id="add-prize-button" class="px-4 py-2 bg-primary text-white rounded hover:bg-blue-600 transition-all-300 flex items-center">
                    <i class="fa fa-plus mr-2"></i> 添加好运
                </button>
            </div>
        </div>
        
        <!-- 中奖记录卡片 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-star mr-2 text-primary"></i> 抽好运记录
            </h2>
            
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                <div class="flex items-center mb-4 md:mb-0">
                    <span class="text-sm text-gray-600 mr-2">搜索:</span>
                    <input type="text" id="winner-search" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="输入姓名或奖项">
                </div>
                <div class="flex items-center">
                    <span class="text-sm text-gray-600 mr-2">排序:</span>
                    <select id="winner-sort" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="time-desc">时间（新→旧）</option>
                        <option value="time-asc">时间（旧→新）</option>
                        <option value="name-asc">姓名（A→Z）</option>
                        <option value="name-desc">姓名（Z→A）</option>
                        <option value="prize-asc">好运（低→高）</option>
                        <option value="prize-desc">好运（高→低）</option>
                    </select>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                姓名
                            </th>
                            <th class="py-3 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                好运
                            </th>
                            <th class="py-3 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                时间
                            </th>
                            <th class="py-3 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                操作
                            </th>
                        </tr>
                    </thead>
                    <tbody id="winners-table-body">
                        <!-- 抽好运记录将通过JS动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            <div class="mt-4 flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    显示 <span id="page-info-start">1</span> 到 <span id="page-info-end">10</span> 条，共 <span id="page-info-total">0</span> 条记录
                </div>
                <div class="flex space-x-2">
                    <button id="prev-page" class="px-3 py-1 border border-gray-300 rounded-md text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa fa-chevron-left"></i>
                    </button>
                    <button id="next-page" class="px-3 py-1 border border-gray-300 rounded-md text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 系统设置卡片 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-cog mr-2 text-primary"></i> 系统设置
            </h2>
            
            <!-- 背景图片设置 -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">背景图片设置</h3>
                <p class="text-sm text-gray-500 mb-4">上传自定义背景图片（建议尺寸：750×1334像素）</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 当前背景预览 -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">当前背景</h4>
                        <div id="current-background" class="w-full h-40 bg-cover bg-center rounded-md flex items-center justify-center">
                            <span class="text-gray-400">无背景图片</span>
                        </div>
                    </div>
                    
                    <!-- 上传新背景 -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">上传新背景</h4>
                        <div class="flex flex-col space-y-3">
                            <input type="file" id="background-file" accept="image/*" class="hidden">
                            <label for="background-file" class="px-4 py-2 bg-primary text-white rounded cursor-pointer hover:bg-blue-600 transition-all-300 text-center">
                                <i class="fa fa-upload mr-2"></i> 选择图片
                            </label>
                            <div id="background-file-name" class="text-sm text-gray-600 truncate"></div>
                            <button id="upload-background" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-all-300 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                <i class="fa fa-check mr-2"></i> 上传并应用
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 其他设置 -->
            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-3">其他设置</h3>
                
                <div class="space-y-4">
                    <!-- 管理员密码修改 -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">修改管理员密码</h4>
                        <div class="flex flex-col md:flex-row md:items-end space-y-3 md:space-y-0 md:space-x-3">
                            <input type="password" id="new-password" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent flex-1" placeholder="新密码">
                            <input type="password" id="confirm-password" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent flex-1" placeholder="确认密码">
                            <button id="change-password" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-all-300">
                                <i class="fa fa-save mr-2"></i> 保存
                            </button>
                        </div>
                    </div>
                    
                    <!-- 重置数据 -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">重置数据</h4>
                        <p class="text-sm text-red-500 mb-3">警告：此操作将清除所有抽好运记录，谨慎操作！</p>
                        <button id="reset-data" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-all-300">
                            <i class="fa fa-refresh mr-2"></i> 重置所有抽好运记录
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-4 relative z-10">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>© 2025 马年迎好运活动管理系统 | 版本 1.0.0</p>
        </div>
    </footer>

    <!-- 添加奖项弹窗 -->
    <div id="add-prize-modal" class="fixed inset-0 z-50 flex items-center justify-center px-4 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" id="add-prize-overlay"></div>
        <div class="relative bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <button id="close-add-prize" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <i class="fa fa-times text-xl"></i>
            </button>
            
            <h3 class="text-xl font-bold text-gray-800 mb-4">添加好运</h3>
            
            <div class="space-y-4">
                <div>
                    <label for="prize-name" class="block text-sm font-medium text-gray-700 mb-1">好运名称</label>
                    <input type="text" id="prize-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="例如：一等奖">
                </div>
                
                <div>
                    <label for="prize-quantity" class="block text-sm font-medium text-gray-700 mb-1">好运数量</label>
                    <input type="number" id="prize-quantity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="例如：1" min="1">
                </div>
                
                <div>
                    <label for="prize-probability" class="block text-sm font-medium text-gray-700 mb-1">抽中概率权重</label>
                    <input type="number" id="prize-probability" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="例如：0.1" min="0" step="0.01">
                    <p class="text-xs text-gray-500 mt-1">权重越高，抽中概率越大</p>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-add-prize" class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-all-300">
                    取消
                </button>
                <button id="confirm-add-prize" class="px-4 py-2 bg-primary text-white rounded hover:bg-blue-600 transition-all-300">
                    添加
                </button>
            </div>
        </div>
    </div>

    <!-- 确认弹窗 -->
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center px-4 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" id="confirm-overlay"></div>
        <div class="relative bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <button id="close-confirm" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <i class="fa fa-times text-xl"></i>
            </button>
            
            <h3 class="text-xl font-bold text-gray-800 mb-4">确认操作</h3>
            
            <p id="confirm-message" class="text-gray-700 mb-6">确认信息将显示在这里</p>
            
            <div class="flex justify-end space-x-3">
                <button id="cancel-confirm" class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-all-300">
                    取消
                </button>
                <button id="accept-confirm" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-all-300">
                    确认
                </button>
            </div>
        </div>
    </div>

    <!-- 提示弹窗 -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg transform translate-y-10 opacity-0 transition-all duration-300 z-50">
        <div class="flex items-center">
            <i class="fa fa-check-circle mr-2"></i>
            <span id="toast-message">操作成功</span>
        </div>
    </div>

    <script>
        // 全局数据
        let participantList = []; // 参与名单
        let prizeList = [];       // 好运列表
        let winnerList = [];      // 抽好运记录
        
        // 分页设置
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredWinners = [];
        
        // 默认好运设置
        const defaultPrizes = [
            { id: "1", name: "一等奖", quantity: 1, remaining: 1, probability: 0.05 },
            { id: "2", name: "二等奖", quantity: 3, remaining: 3, probability: 0.1 },
            { id: "3", name: "三等奖", quantity: 5, remaining: 5, probability: 0.15 },
            { id: "4", name: "四等奖", quantity: 10, remaining: 10, probability: 0.2 },
            { id: "5", name: "五等奖", quantity: 20, remaining: 20, probability: 0.2 },
            { id: "6", name: "六等奖", quantity: 30, remaining: 30, probability: 0.15 },
            { id: "7", name: "七等奖", quantity: 50, remaining: 50, probability: 0.1 },
            { id: "special", name: "一马当先", quantity: 999, remaining: 999, probability: 1 } // 特殊好运
        ];
        
        // 默认参与名单（示例数据）
        const defaultParticipants = [
            { id: "1", name: "张三", isWinner: false, prizeId: null },
            { id: "2", name: "李四", isWinner: false, prizeId: null },
            { id: "3", name: "王五", isWinner: false, prizeId: null },
            { id: "4", name: "赵六", isWinner: false, prizeId: null },
            { id: "5", name: "钱七", isWinner: false, prizeId: null },
            { id: "6", name: "孙八", isWinner: false, prizeId: null },
            { id: "7", name: "周九", isWinner: false, prizeId: null },
            { id: "8", name: "吴十", isWinner: false, prizeId: null }
        ];

        // DOM 元素
        const backToDrawButton = document.getElementById('back-to-draw');
        const logoutButton = document.getElementById('logout-button');
        
        // 文件上传元素
        const participantsFile = document.getElementById('participants-file');
        const participantsFileName = document.getElementById('participants-file-name');
        const importParticipantsButton = document.getElementById('import-participants');
        
        const prizesFile = document.getElementById('prizes-file');
        const prizesFileName = document.getElementById('prizes-file-name');
        const importPrizesButton = document.getElementById('import-prizes');
        
        const exportWinnersButton = document.getElementById('export-winners');
        
        // 奖项管理元素
        const prizesTableBody = document.getElementById('prizes-table-body');
        const addPrizeButton = document.getElementById('add-prize-button');
        
        // 中奖记录元素
        const winnersTableBody = document.getElementById('winners-table-body');
        const winnerSearchInput = document.getElementById('winner-search');
        const winnerSortSelect = document.getElementById('winner-sort');
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');
        const pageInfoStart = document.getElementById('page-info-start');
        const pageInfoEnd = document.getElementById('page-info-end');
        const pageInfoTotal = document.getElementById('page-info-total');
        
        // 背景设置元素
        const currentBackground = document.getElementById('current-background');
        const backgroundFile = document.getElementById('background-file');
        const backgroundFileName = document.getElementById('background-file-name');
        const uploadBackgroundButton = document.getElementById('upload-background');
        
        // 密码修改元素
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const changePasswordButton = document.getElementById('change-password');
        
        // 重置数据元素
        const resetDataButton = document.getElementById('reset-data');
        
        // 弹窗元素
        const addPrizeModal = document.getElementById('add-prize-modal');
        const addPrizeOverlay = document.getElementById('add-prize-overlay');
        const closeAddPrize = document.getElementById('close-add-prize');
        const cancelAddPrize = document.getElementById('cancel-add-prize');
        const confirmAddPrize = document.getElementById('confirm-add-prize');
        
        const confirmModal = document.getElementById('confirm-modal');
        const confirmOverlay = document.getElementById('confirm-overlay');
        const closeConfirm = document.getElementById('close-confirm');
        const cancelConfirm = document.getElementById('cancel-confirm');
        const acceptConfirm = document.getElementById('accept-confirm');
        const confirmMessage = document.getElementById('confirm-message');
        
        // 提示元素
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        
        // 临时存储
        let participantsFileData = null;
        let prizesFileData = null;
        let backgroundFileData = null;
        let currentConfirmAction = null;
        let currentPrizeId = null;
        
        // 初始化函数
        function init() {
            // 验证管理员登录
            verifyAdminLogin();
            
            // 加载数据
            loadData();
            
            // 更新UI
            updatePrizesTable();
            updateWinnersTable();
            updateBackgroundPreview();
            
            // 绑定事件
            bindEvents();
        }
        
        // 验证管理员登录
        function verifyAdminLogin() {
            // 简单验证，实际应用中应该更安全
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            if (!isLoggedIn) {
                window.location.href = 'index.html';
            }
        }
        
        // 加载数据
        function loadData() {
            // 从 localStorage 加载数据
            const savedParticipants = localStorage.getItem('participantList');
            const savedPrizes = localStorage.getItem('prizeList');
            const savedWinners = localStorage.getItem('winnerList');
            
            // 如果有保存的数据则加载，否则使用默认数据
            participantList = savedParticipants ? JSON.parse(savedParticipants) : defaultParticipants;
            prizeList = savedPrizes ? JSON.parse(savedPrizes) : defaultPrizes;
            winnerList = savedWinners ? JSON.parse(savedWinners) : [];
            
            // 更新奖项剩余数量
            updatePrizeRemaining();
        }
        
        // 保存数据
        function saveData() {
            localStorage.setItem('participantList', JSON.stringify(participantList));
            localStorage.setItem('prizeList', JSON.stringify(prizeList));
            localStorage.setItem('winnerList', JSON.stringify(winnerList));
        }
        
        // 更新奖项剩余数量
        function updatePrizeRemaining() {
            // 重置所有奖项的剩余数量
            prizeList.forEach(prize => {
                prize.remaining = prize.quantity;
            });
            
            // 根据中奖记录减少剩余数量
            winnerList.forEach(winner => {
                const prize = prizeList.find(p => p.id === winner.prizeId);
                if (prize) {
                    prize.remaining--;
                }
            });
        }
        
        // 绑定事件
        function bindEvents() {
            // 返回抽奖页
            backToDrawButton.addEventListener('click', () => {
                window.location.href = 'index.html';
            });
            
            // 退出登录
            logoutButton.addEventListener('click', () => {
                localStorage.setItem('adminLoggedIn', 'false');
                window.location.href = 'index.html';
            });
            
            // 文件选择事件
            participantsFile.addEventListener('change', handleParticipantsFileSelect);
            prizesFile.addEventListener('change', handlePrizesFileSelect);
            backgroundFile.addEventListener('change', handleBackgroundFileSelect);
            
            // 导入按钮事件
            importParticipantsButton.addEventListener('click', importParticipants);
            importPrizesButton.addEventListener('click', importPrizes);
            exportWinnersButton.addEventListener('click', exportWinners);
            
            // 奖项管理事件
            addPrizeButton.addEventListener('click', showAddPrizeModal);
            closeAddPrize.addEventListener('click', hideAddPrizeModal);
            addPrizeOverlay.addEventListener('click', hideAddPrizeModal);
            cancelAddPrize.addEventListener('click', hideAddPrizeModal);
            confirmAddPrize.addEventListener('click', addPrize);
            
            // 中奖记录事件
            winnerSearchInput.addEventListener('input', handleWinnerSearch);
            winnerSortSelect.addEventListener('change', handleWinnerSort);
            prevPageButton.addEventListener('click', goToPrevPage);
            nextPageButton.addEventListener('click', goToNextPage);
            
            // 背景设置事件
            uploadBackgroundButton.addEventListener('click', uploadBackground);
            
            // 密码修改事件
            changePasswordButton.addEventListener('click', changePassword);
            
            // 重置数据事件
            resetDataButton.addEventListener('click', () => {
                showConfirmModal('确定要重置所有抽好运记录吗？此操作不可撤销！', resetWinnersData);
            });
            
            // 确认弹窗事件
            closeConfirm.addEventListener('click', hideConfirmModal);
            confirmOverlay.addEventListener('click', hideConfirmModal);
            cancelConfirm.addEventListener('click', hideConfirmModal);
            acceptConfirm.addEventListener('click', executeConfirmAction);
        }
        
        // 处理参与者文件选择
        function handleParticipantsFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                participantsFileName.textContent = file.name;
                participantsFileData = file;
                importParticipantsButton.disabled = false;
            }
        }
        
        // 处理奖项文件选择
        function handlePrizesFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                prizesFileName.textContent = file.name;
                prizesFileData = file;
                importPrizesButton.disabled = false;
            }
        }
        
        // 处理背景文件选择
        function handleBackgroundFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                backgroundFileName.textContent = file.name;
                backgroundFileData = file;
                uploadBackgroundButton.disabled = false;
            }
        }
        
        // 导入参与者名单
        function importParticipants() {
            if (!participantsFileData) {
                showToast('请先选择Excel文件', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // 验证数据格式
                    if (!jsonData || jsonData.length === 0) {
                        showToast('Excel文件中没有数据', 'error');
                        return;
                    }
                    
                    // 检查是否有姓名列
                    const firstRow = jsonData[0];
                    let nameColumn = null;
                    
                    for (const key in firstRow) {
                        if (key.includes('姓名') || key === 'name' || key === 'Name') {
                            nameColumn = key;
                            break;
                        }
                    }
                    
                    if (!nameColumn) {
                        showToast('Excel文件中没有找到姓名列', 'error');
                        return;
                    }
                    
                    // 转换数据格式
                    const newParticipants = jsonData.map((row, index) => {
                        return {
                            id: (index + 1).toString(),
                            name: row[nameColumn].toString().trim(),
                            isWinner: false,
                            prizeId: null
                        };
                    });
                    
                    // 保存数据
                    participantList = newParticipants;
                    saveData();
                    
                    showToast(`成功导入 ${newParticipants.length} 名参与者`);
                    participantsFileData = null;
                    participantsFileName.textContent = '';
                    importParticipantsButton.disabled = true;
                } catch (error) {
                    showToast('导入失败：' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showToast('读取文件失败', 'error');
            };
            
            reader.readAsArrayBuffer(participantsFileData);
        }
        
        // 导入奖项设置
        function importPrizes() {
            if (!prizesFileData) {
                showToast('请先选择Excel文件', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // 验证数据格式
                    if (!jsonData || jsonData.length === 0) {
                        showToast('Excel文件中没有数据', 'error');
                        return;
                    }
                    
                    // 检查必要列
                    const firstRow = jsonData[0];
                    let nameColumn = null;
                    let quantityColumn = null;
                    let probabilityColumn = null;
                    
                    for (const key in firstRow) {
                        if (key.includes('奖项') || key.includes('好运') || key.includes('名称') || key === 'name' || key === 'Name') {
                            nameColumn = key;
                        } else if (key.includes('数量') || key === 'quantity' || key === 'Quantity') {
                            quantityColumn = key;
                        } else if (key.includes('概率') || key.includes('权重') || key === 'probability' || key === 'Probability') {
                            probabilityColumn = key;
                        }
                    }
                    
                    if (!nameColumn || !quantityColumn) {
                        showToast('Excel文件中缺少必要的列（好运名称、数量）', 'error');
                        return;
                    }
                    
                    // 转换数据格式
                    const newPrizes = jsonData.map((row, index) => {
                        const quantity = parseInt(row[quantityColumn]);
                        const probability = probabilityColumn ? parseFloat(row[probabilityColumn]) : 0.1;
                        
                        return {
                            id: (index + 1).toString(),
                            name: row[nameColumn].toString().trim(),
                            quantity: isNaN(quantity) ? 1 : quantity,
                            remaining: isNaN(quantity) ? 1 : quantity,
                            probability: isNaN(probability) ? 0.1 : probability
                        };
                    });
                    
                    // 确保特殊好运存在
                    const specialPrizeExists = newPrizes.some(prize => prize.id === 'special');
                    if (!specialPrizeExists) {
                        newPrizes.push({
                            id: 'special',
                            name: '一马当先',
                            quantity: 999,
                            remaining: 999,
                            probability: 1
                        });
                    }
                    
                    // 保存数据
                    prizeList = newPrizes;
                    saveData();
                    
                    // 更新UI
                    updatePrizesTable();
                    
                    showToast(`成功导入 ${newPrizes.length} 个好运`);
                    prizesFileData = null;
                    prizesFileName.textContent = '';
                    importPrizesButton.disabled = true;
                } catch (error) {
                    showToast('导入失败：' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showToast('读取文件失败', 'error');
            };
            
            reader.readAsArrayBuffer(prizesFileData);
        }
        
        // 导出中奖名单
        function exportWinners() {
            if (winnerList.length === 0) {
                showToast('暂无抽好运记录', 'error');
                return;
            }
            
            try {
                // 准备导出数据
                const exportData = winnerList.map(winner => {
                    return {
                        '姓名': winner.name,
                        '好运': winner.prizeName,
                        '时间': new Date(winner.timestamp).toLocaleString('zh-CN')
                    };
                });
                
                // 创建工作簿
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                
                // 添加工作表到工作簿
                XLSX.utils.book_append_sheet(workbook, worksheet, '抽好运记录');
                
                // 生成Excel文件并下载
                const fileName = `抽好运名单_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);
                
                showToast('导出成功');
            } catch (error) {
                showToast('导出失败：' + error.message, 'error');
            }
        }
        
        // 更新奖项表格
        function updatePrizesTable() {
            prizesTableBody.innerHTML = '';
            
            // 按ID排序，特殊奖项放在最后
            const sortedPrizes = [...prizeList].sort((a, b) => {
                if (a.id === 'special') return 1;
                if (b.id === 'special') return -1;
                return parseInt(a.id) - parseInt(b.id);
            });
            
            sortedPrizes.forEach(prize => {
                const row = document.createElement('tr');
                
                // 奖项名称
                const nameCell = document.createElement('td');
                nameCell.className = 'py-3 px-4 border-b border-gray-200';
                nameCell.innerHTML = `<div class="font-medium text-gray-900">${prize.name}</div>`;
                row.appendChild(nameCell);
                
                // 总数量
                const quantityCell = document.createElement('td');
                quantityCell.className = 'py-3 px-4 border-b border-gray-200';
                quantityCell.textContent = prize.quantity;
                row.appendChild(quantityCell);
                
                // 剩余数量
                const remainingCell = document.createElement('td');
                remainingCell.className = 'py-3 px-4 border-b border-gray-200';
                
                const remainingSpan = document.createElement('span');
                remainingSpan.className = prize.remaining === 0 ? 'text-red-500 font-medium' : 'text-gray-900';
                remainingSpan.textContent = prize.remaining;
                
                remainingCell.appendChild(remainingSpan);
                row.appendChild(remainingCell);
                
                // 已抽取
                const drawnCell = document.createElement('td');
                drawnCell.className = 'py-3 px-4 border-b border-gray-200';
                drawnCell.textContent = prize.quantity - prize.remaining;
                row.appendChild(drawnCell);
                
                // 操作
                const actionCell = document.createElement('td');
                actionCell.className = 'py-3 px-4 border-b border-gray-200';
                
                // 非特殊奖项可以编辑和删除
                if (prize.id !== 'special') {
                    const editButton = document.createElement('button');
                    editButton.className = 'px-2 py-1 text-xs text-blue-600 hover:text-blue-800 mr-2';
                    editButton.innerHTML = '<i class="fa fa-pencil"></i> 编辑';
                    editButton.addEventListener('click', () => editPrize(prize.id));
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'px-2 py-1 text-xs text-red-600 hover:text-red-800';
                    deleteButton.innerHTML = '<i class="fa fa-trash"></i> 删除';
                    deleteButton.addEventListener('click', () => {
                        showConfirmModal(`确定要删除"${prize.name}"吗？`, () => deletePrize(prize.id));
                    });
                    
                    actionCell.appendChild(editButton);
                    actionCell.appendChild(deleteButton);
                } else {
                    actionCell.textContent = '系统奖项';
                    actionCell.className += ' text-gray-500';
                }
                
                row.appendChild(actionCell);
                prizesTableBody.appendChild(row);
            });
        }
        
        // 显示添加奖项弹窗
        function showAddPrizeModal() {
            document.getElementById('prize-name').value = '';
            document.getElementById('prize-quantity').value = '1';
            document.getElementById('prize-probability').value = '0.1';
            addPrizeModal.classList.remove('hidden');
        }
        
        // 隐藏添加奖项弹窗
        function hideAddPrizeModal() {
            addPrizeModal.classList.add('hidden');
        }
        
        // 添加奖项
        function addPrize() {
            const name = document.getElementById('prize-name').value.trim();
            const quantity = parseInt(document.getElementById('prize-quantity').value);
            const probability = parseFloat(document.getElementById('prize-probability').value);
            
            // 验证输入
            if (!name) {
                showToast('请输入奖项名称', 'error');
                return;
            }
            
            if (isNaN(quantity) || quantity < 1) {
                showToast('请输入有效的数量', 'error');
                return;
            }
            
            if (isNaN(probability) || probability < 0) {
                showToast('请输入有效的概率权重', 'error');
                return;
            }
            
            // 检查是否已存在同名奖项
            const existingPrize = prizeList.find(prize => prize.name === name && prize.id !== 'special');
            if (existingPrize) {
                showToast('已存在同名奖项', 'error');
                return;
            }
            
            // 生成新ID
            const maxId = prizeList
                .filter(prize => prize.id !== 'special')
                .reduce((max, prize) => Math.max(max, parseInt(prize.id) || 0), 0);
            const newId = (maxId + 1).toString();
            
            // 创建新奖项
            const newPrize = {
                id: newId,
                name: name,
                quantity: quantity,
                remaining: quantity,
                probability: probability
            };
            
            // 添加到列表
            prizeList.push(newPrize);
            
            // 保存数据
            saveData();
            
            // 更新UI
            updatePrizesTable();
            
            // 隐藏弹窗
            hideAddPrizeModal();
            
            showToast('奖项添加成功');
        }
        
        // 编辑奖项
        function editPrize(id) {
            const prize = prizeList.find(p => p.id === id);
            if (!prize) return;
            
            // 填充表单
            document.getElementById('prize-name').value = prize.name;
            document.getElementById('prize-quantity').value = prize.quantity;
            document.getElementById('prize-probability').value = prize.probability;
            
            // 保存当前编辑的奖项ID
            currentPrizeId = id;
            
            // 修改确认按钮文本
            confirmAddPrize.textContent = '更新';
            
            // 显示弹窗
            addPrizeModal.classList.remove('hidden');
            
            // 移除旧的事件监听
            const newConfirmAddPrize = confirmAddPrize.cloneNode(true);
            confirmAddPrize.parentNode.replaceChild(newConfirmAddPrize, confirmAddPrize);
            
            // 添加新的事件监听
            newConfirmAddPrize.addEventListener('click', updatePrize);
        }
        
        // 更新奖项
        function updatePrize() {
            const name = document.getElementById('prize-name').value.trim();
            const quantity = parseInt(document.getElementById('prize-quantity').value);
            const probability = parseFloat(document.getElementById('prize-probability').value);
            
            // 验证输入
            if (!name) {
                showToast('请输入奖项名称', 'error');
                return;
            }
            
            if (isNaN(quantity) || quantity < 1) {
                showToast('请输入有效的数量', 'error');
                return;
            }
            
            if (isNaN(probability) || probability < 0) {
                showToast('请输入有效的概率权重', 'error');
                return;
            }
            
            // 检查是否已存在同名奖项（排除当前编辑的奖项）
            const existingPrize = prizeList.find(prize => prize.name === name && prize.id !== currentPrizeId && prize.id !== 'special');
            if (existingPrize) {
                showToast('已存在同名奖项', 'error');
                return;
            }
            
            // 查找并更新奖项
            const prizeIndex = prizeList.findIndex(p => p.id === currentPrizeId);
            if (prizeIndex !== -1) {
                // 计算数量变化
                const oldQuantity = prizeList[prizeIndex].quantity;
                const quantityDiff = quantity - oldQuantity;
                
                // 更新奖项信息
                prizeList[prizeIndex].name = name;
                prizeList[prizeIndex].quantity = quantity;
                prizeList[prizeIndex].remaining = prizeList[prizeIndex].remaining + quantityDiff;
                prizeList[prizeIndex].probability = probability;
                
                // 确保剩余数量不小于0
                if (prizeList[prizeIndex].remaining < 0) {
                    prizeList[prizeIndex].remaining = 0;
                }
                
                // 保存数据
                saveData();
                
                // 更新UI
                updatePrizesTable();
                
                // 隐藏弹窗
                hideAddPrizeModal();
                
                // 重置状态
                currentPrizeId = null;
                
                // 恢复确认按钮文本
                confirmAddPrize.textContent = '添加';
                
                showToast('奖项更新成功');
            }
        }
        
        // 删除奖项
        function deletePrize(id) {
            // 查找奖项
            const prizeIndex = prizeList.findIndex(p => p.id === id);
            if (prizeIndex === -1) return;
            
            // 检查是否有用户中了这个奖项
            const prizeName = prizeList[prizeIndex].name;
            const hasWinners = winnerList.some(winner => winner.prizeId === id);
            
            if (hasWinners) {
                showToast(`无法删除"${prizeName}"，已有用户抽中此好运`, 'error');
                return;
            }
            
            // 删除奖项
            prizeList.splice(prizeIndex, 1);
            
            // 保存数据
            saveData();
            
            // 更新UI
            updatePrizesTable();
            
            showToast('好运删除成功');
        }
        
        // 更新抽好运记录表格
        function updateWinnersTable() {
            winnersTableBody.innerHTML = '';
            
            // 应用搜索和排序
            applySearchAndSort();
            
            // 计算分页
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredWinners.length);
            const pageItems = filteredWinners.slice(startIndex, endIndex);
            
            // 更新分页信息
            pageInfoStart.textContent = filteredWinners.length > 0 ? startIndex + 1 : 0;
            pageInfoEnd.textContent = endIndex;
            pageInfoTotal.textContent = filteredWinners.length;
            
            // 更新分页按钮状态
            prevPageButton.disabled = currentPage === 1;
            nextPageButton.disabled = endIndex >= filteredWinners.length;
            
            // 生成表格行
            if (pageItems.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="4" class="py-4 px-4 text-center text-gray-500">
                        暂无中奖记录
                    </td>
                `;
                winnersTableBody.appendChild(emptyRow);
            } else {
                pageItems.forEach(winner => {
                    const row = document.createElement('tr');
                    
                    // 姓名
                    const nameCell = document.createElement('td');
                    nameCell.className = 'py-3 px-4 border-b border-gray-200';
                    nameCell.innerHTML = `<div class="font-medium text-gray-900">${winner.name}</div>`;
                    row.appendChild(nameCell);
                    
                    // 奖项
                    const prizeCell = document.createElement('td');
                    prizeCell.className = 'py-3 px-4 border-b border-gray-200';
                    
                    const prizeSpan = document.createElement('span');
                    prizeSpan.className = winner.prizeId === 'special' ? 'text-gray-600' : 'text-blue-600 font-medium';
                    prizeSpan.textContent = winner.prizeName;
                    
                    prizeCell.appendChild(prizeSpan);
                    row.appendChild(prizeCell);
                    
                    // 时间
                    const timeCell = document.createElement('td');
                    timeCell.className = 'py-3 px-4 border-b border-gray-200';
                    timeCell.textContent = new Date(winner.timestamp).toLocaleString('zh-CN');
                    row.appendChild(timeCell);
                    
                    // 操作
                    const actionCell = document.createElement('td');
                    actionCell.className = 'py-3 px-4 border-b border-gray-200';
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'px-2 py-1 text-xs text-red-600 hover:text-red-800';
                    deleteButton.innerHTML = '<i class="fa fa-trash"></i> 删除';
                    deleteButton.addEventListener('click', () => {
                        showConfirmModal(`确定要删除"${winner.name}"的中奖记录吗？`, () => deleteWinner(winner.id));
                    });
                    
                    actionCell.appendChild(deleteButton);
                    row.appendChild(actionCell);
                    
                    winnersTableBody.appendChild(row);
                });
            }
        }
        
        // 应用搜索和排序
        function applySearchAndSort() {
            // 应用搜索
            const searchTerm = winnerSearchInput.value.trim().toLowerCase();
            
            if (searchTerm) {
                filteredWinners = winnerList.filter(winner => {
                    return winner.name.toLowerCase().includes(searchTerm) || 
                           winner.prizeName.toLowerCase().includes(searchTerm);
                });
            } else {
                filteredWinners = [...winnerList];
            }
            
            // 应用排序
            const sortOption = winnerSortSelect.value;
            
            switch (sortOption) {
                case 'time-desc':
                    filteredWinners.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    break;
                case 'time-asc':
                    filteredWinners.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    break;
                case 'name-asc':
                    filteredWinners.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name-desc':
                    filteredWinners.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'prize-asc':
                    filteredWinners.sort((a, b) => {
                        // 特殊好运排在最后
                        if (a.prizeId === 'special') return 1;
                        if (b.prizeId === 'special') return -1;
                        return parseInt(a.prizeId) - parseInt(b.prizeId);
                    });
                    break;
                case 'prize-desc':
                    filteredWinners.sort((a, b) => {
                        // 特殊好运排在最后
                        if (a.prizeId === 'special') return 1;
                        if (b.prizeId === 'special') return -1;
                        return parseInt(b.prizeId) - parseInt(a.prizeId);
                    });
                    break;
            }
            
            // 重置页码
            currentPage = 1;
        }
        
        // 处理抽好运记录搜索
        function handleWinnerSearch() {
            currentPage = 1;
            updateWinnersTable();
        }
        
        // 处理抽好运记录排序
        function handleWinnerSort() {
            currentPage = 1;
            updateWinnersTable();
        }
        
        // 上一页
        function goToPrevPage() {
            if (currentPage > 1) {
                currentPage--;
                updateWinnersTable();
            }
        }
        
        // 下一页
        function goToNextPage() {
            const maxPage = Math.ceil(filteredWinners.length / itemsPerPage);
            if (currentPage < maxPage) {
                currentPage++;
                updateWinnersTable();
            }
        }
        
        // 删除抽好运记录
        function deleteWinner(id) {
            // 查找中奖记录
            const winnerIndex = winnerList.findIndex(w => w.id === id);
            if (winnerIndex === -1) return;
            
            const winner = winnerList[winnerIndex];
            
            // 如果是名单内的用户，重置其中奖状态
            const participant = participantList.find(p => p.name === winner.name);
            if (participant) {
                participant.isWinner = false;
                participant.prizeId = null;
            }
            
            // 删除抽好运记录
            winnerList.splice(winnerIndex, 1);
            
            // 更新奖项剩余数量
            updatePrizeRemaining();
            
            // 保存数据
            saveData();
            
            // 更新UI
            updatePrizesTable();
            updateWinnersTable();
            
            showToast('抽好运记录删除成功');
        }
        
        // 更新背景预览
        function updateBackgroundPreview() {
            const backgroundImage = localStorage.getItem('backgroundImage');
            
            if (backgroundImage) {
                currentBackground.style.backgroundImage = `url(${backgroundImage})`;
                currentBackground.innerHTML = '';
            } else {
                currentBackground.style.backgroundImage = '';
                currentBackground.innerHTML = '<span class="text-gray-400">无背景图片</span>';
            }
        }
        
        // 上传背景图片
        function uploadBackground() {
            if (!backgroundFileData) {
                showToast('请先选择图片', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const img = new Image();
                    img.onload = function() {
                        // 创建Canvas进行图片处理
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // 设置Canvas尺寸
                        canvas.width = 750; // 适合移动端的宽度
                        canvas.height = 1334; // 适合移动端的高度
                        
                        // 绘制图片，保持比例并填充
                        const scale = Math.max(canvas.width / img.width, canvas.height / img.height);
                        const x = (canvas.width - img.width * scale) / 2;
                        const y = (canvas.height - img.height * scale) / 2;
                        
                        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                        
                        // 转换为DataURL并保存
                        const dataURL = canvas.toDataURL('image/jpeg', 0.8);
                        localStorage.setItem('backgroundImage', dataURL);
                        
                        // 更新预览
                        updateBackgroundPreview();
                        
                        showToast('背景图片上传成功');
                        backgroundFileData = null;
                        backgroundFileName.textContent = '';
                        uploadBackgroundButton.disabled = true;
                    };
                    
                    img.onerror = function() {
                        showToast('图片加载失败', 'error');
                    };
                    
                    img.src = e.target.result;
                } catch (error) {
                    showToast('上传失败：' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showToast('读取文件失败', 'error');
            };
            
            reader.readAsDataURL(backgroundFileData);
        }
        
        // 修改管理员密码
        function changePassword() {
            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();
            
            if (!newPassword) {
                showToast('请输入新密码', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('两次输入的密码不一致', 'error');
                return;
            }
            
            // 保存新密码
            localStorage.setItem('adminPassword', newPassword);
            
            // 清空输入框
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';
            
            showToast('密码修改成功');
        }
        
        // 重置抽好运数据
        function resetWinnersData() {
            // 重置参与者抽好运状态
            participantList.forEach(participant => {
                participant.isWinner = false;
                participant.prizeId = null;
            });
            
            // 清空抽好运记录
            winnerList = [];
            
            // 更新奖项剩余数量
            updatePrizeRemaining();
            
            // 保存数据
            saveData();
            
            // 更新UI
            updatePrizesTable();
            updateWinnersTable();
            
            showToast('抽好运记录已重置');
        }
        
        // 显示确认弹窗
        function showConfirmModal(message, action) {
            confirmMessage.textContent = message;
            currentConfirmAction = action;
            confirmModal.classList.remove('hidden');
        }
        
        // 隐藏确认弹窗
        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
            currentConfirmAction = null;
        }
        
        // 执行确认操作
        function executeConfirmAction() {
            if (currentConfirmAction) {
                currentConfirmAction();
            }
            hideConfirmModal();
        }
        
        // 显示提示
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            
            // 设置颜色
            if (type === 'error') {
                toast.className = toast.className.replace('bg-green-500', 'bg-red-500');
            } else {
                toast.className = toast.className.replace('bg-red-500', 'bg-green-500');
            }
            
            // 显示提示
            toast.classList.remove('translate-y-10', 'opacity-0');
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
            }, 3000);
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
